---
title: "Analyzing Trips in the Bay Area Bike Share"
output: html_document
---

During my summer travels, I visited many cities around the world with bike sharing systems. As someone who enjoys biking as a means of transport, the concept really appeals to me. Such systems encourage physical activity and can relieve congestion on other public transit options like busses and trams. They also offer another solution to the [Last Mile Problem](http://en.wikipedia.org/wiki/Last_mile_(transportation)), which refers to the question of how to get people from a transportation hub to their final destination.

As an example, the terminus of the Caltrain in San Francisco is quite far from the Financial District, so a transfer to an alternative form of transportation is necessary for commuters destined for that area. I spent a summer making that exact commute. My solution to the problem involved taking my bike with me on the train, but there is limited space for that. For a commuter who does not want to commit to carrying their bike on the crowded train everyday, having the option of picking up a shared bike at the station to go the last mile is enticing.

Bike sharing systems are not without flaws. The most obvious problem is that with enough demand, all of the bikes at your preferred pickup station could be gone. Another (potentially more frustrating) issue is that your preferred dropoff station could be full. Bike sharing systems usually employ people to drive around and rebalance the stock at different stations.

I like riding my bike -- not only for exercise, but also for transportation whenever possible. I often use Google Maps to find a good route, but sometimes their cycling directions seem a bit off. I have always wondered how accurate these estimates actually are.

Recently, I have been experimenting with data provided by the [Bay Area Bike Share](http://www.bayareabikeshare.com/open-data) (BABS) system. I think bike sharing networks are a cool concept, so this has been a fun side project. This data set contains individual trip data complete with origin, destination, and trip duration, so it is perfect for investigating my question.

```{r echo=FALSE, eval=FALSE}
setwd("~/Documents/Projects/BikeShare/Rmd")
```

```{r echo=FALSE, warning=FALSE, message=FALSE}
library(dplyr)
library(readr)
library(stringr)
library(knitr)
library(ggplot2)
source("../R/helpers.R")
```

```{r warning=FALSE}
paths <- getFilePaths()
trip_data <- do.call("rbind", lapply(paths$trip, function(fn) {
  read_csv(fn) %>%
    rename(origin_id = `Start Terminal`,
           destination_id = `End Terminal`,
           origin_station = `Start Station`,
           destination_station = `End Station`,
           subscription = `Subscriber Type`,
           actual_duration = Duration,
           trip_id = `Trip ID`) %>%
    mutate(time = as.POSIXct(`Start Date`, format = "%m/%d/%Y %H:%M"),
           year = format(time, "%Y"),
           month = format(time, "%m"),
           day = format(time, "%d"),
           hour = format(time, "%H"),
           minute = format(time, "%M"),
           weekday = ifelse(format(time, "%a") %in% c("Sat", "Sun"), "Weekend", "Weekday")) %>%
    select(trip_id, origin_id, destination_id, origin_station, destination_station, subscription,
           actual_duration, time, year, month, day, hour, minute, weekday)
}))
```

Through the Google Maps Directions API, I pull cycling estimates for every pair of stations in the same region.  See [here](https://github.com/llefebure/bike-sharing/blob/master/R/google-api-trip-estimates.R) for the full code that generates these numbers.

```{r}
gmaps_estimates <- readRDS("../data/gmaps_trip_estimates.Rds")
```

Next, I merge the trips data with the Google Maps estimates. Because some stations changed location, I need to make sure that each trip matches up with the correct estimate.

```{r}
trip_data_with_est <- inner_join(trip_data, gmaps_estimates) %>%
  mutate(origin_date_match = as.Date(time) >= start_date_origin & 
           as.Date(time) <= end_date_origin,
         destination_date_match = as.Date(time) >= start_date_destination & 
           as.Date(time) <= end_date_destination) %>%
  filter(is.na(origin_date_match) | origin_date_match == TRUE, 
         is.na(destination_date_match) | destination_date_match == TRUE) %>%
  group_by(trip_id) %>%
  arrange(origin_date_match, destination_date_match) %>%
  filter(row_number() == 1) %>%
  ungroup() %>%
  rename(gmaps_duration = duration, gmaps_distance = distance) %>%
  select(origin_id, destination_id, origin_station, destination_station, origin_latlong, 
         destination_latlong, subscription, actual_duration, gmaps_duration, gmaps_distance, 
         year, month, day, hour, minute)
```

```{r}
summary(trip_data_with_est$actual_duration - trip_data_with_est$duration)
```

```{r}
ggplot(trip_data_with_est, aes(actual_duration - duration)) + geom_histogram() + xlim(c(-800, 800))
```

```{r}
a<-trip_data_with_est %>% 
  group_by(origin_id, destination_id, subscription) %>% 
  summarize(avg_len = mean(actual_duration), sd_len = sd(actual_duration), cnt = n()) %>% 
  arrange(origin_id, destination_id)
b<-inner_join(filter(a, subscription == "Customer"), 
           filter(a, subscription == "Subscriber"), 
           by = c("origin_id", "destination_id")) %>%
  mutate(diff = avg_len.x - avg_len.y)
```