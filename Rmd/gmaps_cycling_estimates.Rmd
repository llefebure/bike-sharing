---
title: "Assessing Accuracy of Google Maps Cycling Estimates"
output: html_document
---

I like riding my bike for transportation whenever possible, and like many others, I often use Google Maps to find a route that is both safe and direct. However, their cycling directions sometimes seem a bit off, and I have always wondered how accurate the time estimates actually are for the average cyclist. This skepticism has been echoed by others as well. [^1]

[1^]: See [here](http://www.betterbybicycle.com/2014/09/how-accurate-are-google-maps-cycling.html).

Recently, I have been experimenting with data from the Bay Area Bike Share (BABS) system -- a network of shared bikes docked at stations scattered around the Bay Area. In this analysis, I compare actual trip times from the BABS to Google Maps time estimates to investigate their accuracy. The nature of this data means that this analysis will apply exclusively to short, urban routes in the Bay Area.

```{r echo=FALSE, eval=FALSE}
setwd("~/Documents/Projects/BikeShare/Rmd")
```

```{r echo=FALSE, warning=FALSE, message=FALSE}
library(dplyr)
library(readr)
library(stringr)
library(knitr)
library(ggplot2)
source("../R/helpers.R")
```

## Data

### BABS

The BABS makes trip data publically available [here](http://www.bayareabikeshare.com/open-data). It consists of individual records for 669,959 trips made between 8/31/2013 and 8/31/2015 complete with information like origin, destination, duration, start time, and more.

```{r warning=FALSE, message=FALSE, echo=FALSE}
paths <- getFilePaths()
trip_data <- do.call("rbind", lapply(paths$trip, function(fn) {
  date_fmt <- ifelse(grepl("201402", fn), "%m/%d/%y %H:%M", "%m/%d/%Y %H:%M")
  read_csv(fn) %>%
    rename(origin_id = `Start Terminal`,
           destination_id = `End Terminal`,
           origin_station = `Start Station`,
           destination_station = `End Station`,
           subscription = `Subscriber Type`,
           actual_duration = Duration,
           trip_id = `Trip ID`) %>%
    mutate(time = as.POSIXct(`Start Date`, format = date_fmt),
           year = format(time, "%Y"),
           month = format(time, "%m"),
           day = format(time, "%d"),
           hour = format(time, "%H"),
           minute = format(time, "%M"),
           weekday = ifelse(format(time, "%a") %in% c("Sat", "Sun"), "Weekend", "Weekday")) %>%
    select(trip_id, origin_id, destination_id, origin_station, destination_station, subscription,
           actual_duration, time, year, month, day, hour, minute, weekday)
}))
```

There are five different cities served by the BABS: San Francisco, Redwood City, Palo Alto, Mountain View, and San Jose. While it is possible to take a bike between cities, I filter those trips out because of their rarity and the possibility that a trip from San Francisco to Palo Alto, for example, includes a stint on the Caltrain.

Below is a histogram of the actual duration of the remaining trips. It is cut off at 1,800 seconds (30 minutes), but there are some trips that are significantly longer. These outliers are dealt with later. The distribution is skewed off to the right as we would expect since a cyclist can take an arbitrarily long amount of time to complete their trip.

```{r echo=FALSE, warning=FALSE, message=FALSE}
ggplot(trip_data, aes(actual_duration)) +
  geom_histogram() +
  lims(x = c(0, 1800)) +
  labs(title = "Distribution of Actual Trip Length",
       x = "Duration (s)",
       y = "Count of Trips")
```

### Google Maps Estimates

Through the Google Maps Directions API, I pull cycling estimates for every pair of stations in the same city. See [here](https://github.com/llefebure/bike-sharing/blob/master/R/google-api-trip-estimates.R) for the full code that generates those numbers. In addition, some stations changed location, so certain routes affected by this have multiple estimates with corresponding date ranges.

```{r echo=FALSE}
gmaps_estimates <- readRDS("../data/gmaps_trip_estimates.Rds")
gmaps_estimates <- gmaps_estimates %>%
  filter(origin_id != destination_id)
```

The relationship between the cycling distance (in meters) of a trip and its expected duration (in seconds) as reported by Google Maps is plotted below for each route. There is clearly a strong linear trend with some heteroskedasticity. As trips increase in distance, the variance of their expected duration increases. Trips range in distance from about 50 meters to 6,000 meters and in duration from about 10 seconds to 23 minutes.

```{r echo=FALSE, warning=FALSE}
ggplot(gmaps_estimates, aes(distance, duration)) + 
  geom_point() + 
  labs(x = "Distance (m)",
       y = "Duration (s)",
       title = "Google Maps Routes")
```

From this data, I infer the expected average cycling speed for each route by scaling the ratio of duration and time. This distribution is shown below. The average expected speed of a route is between 8 and 9 miles per hour.

```{r echo=FALSE, warning=FALSE}
ggplot(gmaps_estimates, aes((distance/duration)/1000*3600/1.609)) + 
  geom_histogram() + 
  labs(x = "Speed (mph)",
       y = "Count of Routes",
       title = "Average Expected Speed by Route")
```

## Removing Outliers

```{r message=FALSE, echo=FALSE}
trip_data_with_est <- inner_join(trip_data, gmaps_estimates) %>%
  mutate(origin_date_match = as.Date(time) >= start_date_origin & 
           as.Date(time) <= end_date_origin,
         destination_date_match = as.Date(time) >= start_date_destination & 
           as.Date(time) <= end_date_destination) %>%
  filter(is.na(origin_date_match) | origin_date_match == TRUE, 
         is.na(destination_date_match) | destination_date_match == TRUE) %>%
  group_by(trip_id) %>%
  arrange(origin_date_match, destination_date_match) %>%
  filter(row_number() == 1) %>%
  ungroup() %>%
  rename(gmaps_duration = duration, gmaps_distance = distance) %>%
  mutate(duration_diff = actual_duration - gmaps_duration) %>%
  select(origin_id, destination_id, origin_station, destination_station, origin_latlong, 
         destination_latlong, subscription, actual_duration, gmaps_duration, duration_diff,
         gmaps_distance, year, month, day, weekday, hour, minute)
```

My ultimate goal is to compare actual trip times with Google Maps estimates, so I need to filter out trips that were not continuous point to point journeys. For example, it is possible that a tourist stops several times to take photos before reaching their destination. Trips such as these could very easily skew the analysis. A quick look at the distribution of trip times reveals at least one obvious outlier.

```{r echo=FALSE}
trip_time_dist <- data.frame(t(as.matrix(summary(trip_data_with_est$actual_duration))))
colnames(trip_time_dist) <- c("Min", "First Quartile", "Median", "Mean", "Third Quartile", "Max")
kable(trip_time_dist)
```

Clearly nobody made a continuous trip of over 17,000,000 seconds, which equates to approximately 200 days. However, finding the not so obvious discontinuous trips is more challenging. The BABS imposes overage charges on any trip that lasts longer than 30 minutes, so the system is setup to discourage those longer, discontinuous journeys. As a first step, I will filter out all trips longer than 30 minutes.

```{r echo=FALSE}
trip_data_with_est <- trip_data_with_est %>%
  filter(actual_duration <= 1800)
```

There is an additional piece of important information attached to each trip. From the subscriber type, we can make educated inferences about the trip. Subscribers are those with annual or 30 day memberships, and customers are those with 24 hour or 3 day passes. I expect that subscribers are those that use the system for commuting and transportation exclusively, while customers can include tourists who use the system for exploring the area. Plotted below is the same histogram as above, but stacked by the subscription type. As expected, customers ride slower. I filter out these trips.

```{r echo=FALSE, message=FALSE}
ggplot(trip_data_with_est, aes(x=duration_diff, fill=subscription)) + 
  geom_histogram() + 
  labs(title = "Comparison of Trip Duration with Google Maps Estimate",
       x = "Actual Duration Minus Google Maps Estimate",
       y = "Count of Trips")
```

```{r echo=FALSE}
trip_data_with_est <- trip_data_with_est %>%
  filter(subscription == "Subscriber")
```

## Analysis

Among those trips shorter than 30 minutes, the difference between the actual and estimated time is plotted below.

```{r warning=FALSE, message=FALSE, echo=FALSE}
ggplot(trip_data_with_est, aes(duration_diff)) + 
  geom_histogram() + 
  labs(title = "Comparison of Trip Duration with Google Maps Estimate",
       x = "Actual Duration Minus Google Maps Estimate",
       y = "Count of Trips")
```

Trips vary in length significantly. A one minute difference in a five minute trip is much different than a one minute difference in a twenty minute trip, so the above graphs do not show the full picture. Plotted below is a histogram of the proportion difference.

```{r echo=FALSE}
trip_data_with_est <- trip_data_with_est %>%
  mutate(duration_diff_prop = duration_diff/gmaps_duration)
```

```{r echo=FALSE, warning=FALSE, message=FALSE}
ggplot(trip_data_with_est, aes(x=duration_diff_prop)) + 
  geom_histogram() + 
  labs(title = "Comparison of Trip Duration with Google Maps Estimate",
       x = "Proportion Difference from Google Maps Estimate",
       y = "Count of Trips") +
  lims(x = c(-1, 2))
```

A fuller picture of this distribution is shown below. Some outliers were missed, but the distribution is remarkably symmetric. The median trip is just 3% longer than estimated. The extra few seconds it takes to check out a bike and gather your belongings before starting to ride could account for this.

```{r echo=FALSE}
kable(data.frame(t(as.matrix(summary(trip_data_with_est$duration_diff_prop)))))
```

Plot difference by expected duration. i.e for trips between 0 and 200 seconds this is mean and sd (plot error bars)

## Conclusion

Google Maps estimates seem to be quite good on average for routes in the Bay Area. This analysis is restricted to short urban routes in the Bay Area.

* Strava data would be good for this task, and it likely has a different demographic.
* This data is restricted to specific and short urban routes.