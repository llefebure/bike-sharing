---
title: "Forecasting Availability in a Bike Sharing Network"
output: html_document
---

During my summer travels, I visited many cities around the world with bike sharing systems. As someone who enjoys biking as a means of transport, the concept really appeals to me. Such systems encourage physical activity and can relieve congestion on other public transit options like busses and trams. They also offer another solution to the [Last Mile Problem](http://en.wikipedia.org/wiki/Last_mile_(transportation)), which refers to the question of how to get people from a transportation hub to their final destination.

As an example, the terminus of the Caltrain in San Francisco is quite far from the Financial District, so a transfer to an alternative form of transportation is necessary for commuters destined for that area. I spent a summer making that exact commute. My solution to the problem involved taking my bike with me on the train, but there is limited space for that. For a commuter who does not want to commit to carrying their bike on the crowded train everyday, having the option of picking up a shared bike at the station to go the last mile is enticing.

Bike sharing systems are not without flaws. The most obvious problem is that with enough demand, all of the bikes at your preferred pickup station could be gone. Another (potentially more frustrating) issue is that your preferred dropoff station could be full. Bike sharing systems usually employ people to drive around and rebalance the stock at different stations.

## The Task

In this analysis, I will model the arrivals and departures to each dock of the [Bay Area Bike Share](http://www.bayareabikeshare.com/) system to make probabilistic conclusions about the future availability of bikes. More precisely, I will build a model to predict the distribution of bike availablity at each station one hour in the future.

This is important for two reasons. It is valuable to users who want to know if a bike will be available at their pickup station, and rebalancers need to know which stations they should focus their efforts on.

```{r echo=FALSE, eval=FALSE}
setwd("~/Documents/Projects/BikeShare/Rmd")
```

## Data

I will use data on the Bay Area Bike Share program publically available [here](http://www.bayareabikeshare.com/open-data).

```{r}
library(dplyr)
library(readr)
library(stringr)
library(ggplot2)
library(scales)
library(h2o)
source("../R/helpers.R")
```

## Station Availability

```{r eval=FALSE}
file_paths <- getFilePaths()
status_data <- read_csv(file_paths$status[3])
```

```{r}
status_data <- status_data %>%
  mutate(month = format(time, "%m"), 
         day = format(time, "%a"),
         hour = format(time, "%H"),
         minute = format(time, "%M"),
         weekday = ifelse(format(time, "%u") < 6, "1", "0"),
         hm = as.POSIXct(format(time, "%H:%M"), tz = "", format = "%H:%M"))
```

When are stations empty?

```{r}
empty <- filter(status_data, bikes_available == 0)
ggplot(empty, aes(x=as.numeric(hour))) + 
  geom_histogram(binwidth = 1) + 
  labs(x = "Hour", y = "# of Minutes Empty", title = "Empty Docks by Hour")
ggplot(empty, aes(x=day)) +
  geom_bar() + 
  scale_x_discrete(limits = c("Mon", "Tue", "Wed", "Thu", "Fri", "Sat", "Sun")) +
  labs(x = "Day of the Week", y = "# of Minutes Empty", title = "Empty Docks by Day of the Week")
```

When are stations full?

```{r}
full <- filter(status_data, docks_available == 0)
ggplot(full, aes(x=as.numeric(hour))) + 
  geom_histogram(binwidth = 1) + 
  labs(x = "Hour", y = "# of Minutes Full", title = "Full Docks by Hour")
ggplot(full, aes(x=day)) +
  geom_bar() + 
  scale_x_discrete(limits = c("Mon", "Tue", "Wed", "Thu", "Fri", "Sat", "Sun")) +
  labs(x = "Day of the Week", y = "# of Minutes Empty", title = "Full Docks by Day of the Week")
```

```{r}
ggplot(filter(agg, station_id == 77), aes(x = hm, y = avg_bikes_available,
                                         group = weekday, color = weekday)) +
  geom_line() +
  scale_x_datetime(labels = date_format("%H:%M", tz = "America/Los_Angeles"))
```

## Building the Training Set

```{r}
train <- getTrainingSet()
train
```

## Initial Model Building

I will use Poisson regression. I have been wanting to use the h2o package after a presentation by Erin LeDell in one of my classes at Stanford. H2O provides distributed implementations of popular machine learning algorithms, and while I won't use the distributed capability of the package in this project, this will be good practice to potentially do so in a future project.

```{r}
local.h2o <- h2o.init()
```