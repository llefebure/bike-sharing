---
title: "Forecasting Availability in a Bike Sharing Network"
output: html_document
---

During my summer travels, I visited many cities around the world with bike sharing systems. As someone who enjoys biking as a means of transport, the concept really appeals to me. Such systems encourage physical activity and can relieve congestion on other public transit options like busses and trams. They also offer another solution to the [Last Mile Problem](http://en.wikipedia.org/wiki/Last_mile_(transportation)), which refers to the question of how to get people from a transportation hub to their final destination.

As an example, the terminus of the Caltrain in San Francisco is quite far from the Financial District, so a transfer to an alternative form of transportation is necessary for commuters destined for that area. I spent a summer making that exact commute. My solution to the problem involved taking my bike with me on the train, but there is limited space for that. For a commuter who does not want to commit to carrying their bike on the crowded train everyday, having the option of picking up a shared bike at the station to go the last mile is enticing.

Bike sharing systems are not without flaws. The most obvious problem is that with enough demand, all of the bikes at your preferred pickup station could be gone. Another (potentially more frustrating) issue is that your preferred dropoff station could be full. Bike sharing systems usually employ people to drive around and rebalance the stock at different stations.

## The Task

In this analysis, I will model the arrivals and departures to each dock of the [Bay Area Bike Share](http://www.bayareabikeshare.com/) system to make probabilistic conclusions about the future availability of bikes. More precisely, I will build a model to predict the distribution of bike availablity at each station one hour in the future.

This is important for two reasons. It is valuable to users who want to know if a bike will be available at their pickup station, and rebalancers need to know which stations they should focus their efforts on.

```{r echo=FALSE, eval=FALSE}
setwd("~/Documents/Projects/BikeShare/Rmd")
```

## Data

I will use data on the Bay Area Bike Share program publically available [here](http://www.bayareabikeshare.com/open-data) that consists of individual records for all 525,944 trips made between 3/1/2014 and 8/31/2015.

```{r}
library(dplyr)
library(readr)
library(stringr)
library(knitr)
library(ggplot2)
library(scales)
library(h2o)
source("../R/helpers.R")
```

## Building the Training Set

I build the training set from individual trip records using `dplyr` by aggregating over every hour of every day. The definition of `getTrainingSet` can be found [here](http://github.com/llefebure).

```{r}
full <- getProcessedTripData()
train <- full %>% filter(year == "2014" | (year == "2015" & month < "04"))
test <- full %>% filter(year == "2015" & month >= "04")
kable(head(train))
```

## Initial Model Building

```{r}
train.st <- filter(train, station_id == 4)
test.st <- filter(test, station_id == 4)
fit <- glm(arrivals ~ factor(weekday) + factor(hour) + factor(hour):factor(weekday), data = train.st, family = "poisson")

preds <- predict(fit, newdata = test.st, type = "response")
mean(abs(test.st$arrivals - preds)**2)
```